#!/usr/bin/env bash

die() {
    >&2 printf '%s\n' "$*"
    exit 1
}

usage() {
>&2 cat <<EOF
Usage: ${0##*/} [options]
-------------------------------
--name      name for plotter log (optional)
-t          tmp_dir
-d          dest_dir
-2          stage 3/4 tmp_dir
-k          plot_size (32-33-34)
-n          number of plots (default: 1)
-u          number of buckets (default: 128)
-b          max memory (default: 4608m)
-r          number of threads (default: 2)
-e          disable bitfield
EOF
exit 1
}

# bitfield plotting
#
# results in 12% more data to write but less changes in position
# better for SSDs, worse for HDDs
# SAS arrays not sure
#
# if TRUE, disables bitfield plotting
: "${DISABLE_BITFIELD:=FALSE}"

check() {
    if ! [ "$STAGE_1_2_TEMP" ] ; then
        die 'Stage 1+2 temp dir is not set. Use [-t] to indicate.'
    fi
    if ! [ "$DESTINATION" ] ; then
        die 'Destination dir is not set. Use [-d] to indicate.'
    fi
}

launch() {
    if [ "$NAME" ] ; then
        NAME=$(date '+%F-%T')-$NAME.log
    else
        NAME=$(date '+%F-%T').log
    fi

    # shellcheck disable=2046
    {
        chia plots create \
            -t "$STAGE_1_2_TEMP" \
            -d "$DESTINATION" \
            -2 "${STAGE_3_4_TEMP:-$STAGE_1_2_TEMP}" \
            -k "${PLOT_SIZE:-32}" \
            -n "${NUM_PLOTS:-1}" \
            -u "${NUM_BUCKETS:-128}" \
            -b "${MAX_MEMORY:-4608}" \
            -r "${NUM_THREADS:-2}" \
            $([ $DISABLE_BITFIELD = TRUE ] && printf '%s' '-e') | \
            tee "${HOME}/.chia/mainnet/plotter/$NAME"
    } &
    disown
}

main() {
    while [ "$1" ] ; do
        case $1 in
            -t)
                [ "$2" ] || die 'no arg for [-t]?'
                STAGE_1_2_TEMP=$2
                shift 2
                ;;
            -d)
                [ "$2" ] || die 'no arg for [-d]?'
                DESTINATION=$2
                shift 2
                ;;
            -2)
                [ "$2" ] || die 'no arg for [-2]?'
                STAGE_3_4_TEMP=$2
                shift 2
                ;;
            -k)
                [ "$2" ] || die 'no arg for [-k]?'
                PLOT_SIZE=$2
                shift 2
                ;;
            -n)
                [ "$2" ] || die 'no arg for [-n]?'
                NUM_PLOTS=$2
                shift 2
                ;;
            -u)
                [ "$2" ] || die 'no arg for [-u]?'
                NUM_BUCKETS=$2
                shift 2
                ;;
            -b)
                [ "$2" ] || die 'no arg for [-b]?'
                MAX_MEMORY=$2
                shift 2
                ;;
            -r)
                [ "$2" ] || die 'no arg for [-r]?'
                NUM_THREADS=$2
                shift 2
                ;;
            -e)
                DISABLE_BITFIELD=True
                shift
                ;;
            --name)
                [ "$2" ] || die 'no arg for [--name]?'
                NAME=$2
                shift 2
                ;;
            *)
                usage
        esac
    done

    check
    launch
}

main "$@"
